<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scroll Preservation Test</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        .container { display: flex; height: 100vh; }
        .editor { flex: 1; padding: 20px; background: #f5f5f5; }
        .preview { flex: 1; padding: 20px; }
        #preview-iframe { width: 100%; height: 80vh; border: 1px solid #ccc; }
        textarea { width: 100%; height: 200px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; }
        .test-content {
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            margin-bottom: 50px;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="editor">
            <h2>Editor Panel</h2>
            <p>Edit the content below and observe how the preview scroll position is preserved:</p>

            <div>
                <label for="title">Title:</label>
                <input type="text" id="title" value="Portfolio Demo" style="width: 100%; padding: 5px;">
            </div>

            <div>
                <label for="content">Content:</label>
                <textarea id="content">This is a test of the scroll preservation mechanism. When you edit this content and the preview updates, the scroll position in the iframe should be preserved instead of jumping back to the top.</textarea>
            </div>

            <button onclick="updatePreview()">Update Preview</button>
            <button onclick="addSection()">Add Section</button>

            <p><small>Instructions:
            1. Scroll down in the preview iframe on the right
            2. Make changes to the title or content above
            3. Click "Update Preview"
            4. Notice how the scroll position is maintained!
            </small></p>
        </div>

        <div class="preview">
            <h2>Live Preview</h2>
            <iframe id="preview-iframe" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        let scrollPosition = { x: 0, y: 0 };
        let sectionCount = 3;

        // Simplified version of our scroll preservation logic
        function preserveScrollAndUpdate(iframe, newHtml) {
            return new Promise((resolve) => {
                // Store current scroll position
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                if (doc) {
                    scrollPosition = {
                        x: doc.documentElement.scrollLeft || doc.body.scrollLeft || 0,
                        y: doc.documentElement.scrollTop || doc.body.scrollTop || 0
                    };
                    console.log('Stored scroll position:', scrollPosition);
                }

                // Try DOM manipulation first (preferred method)
                try {
                    if (doc && doc.body) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = newHtml;
                        const newBodyContent = tempDiv.querySelector('body').innerHTML;

                        doc.body.innerHTML = newBodyContent;

                        // Restore scroll position immediately
                        requestAnimationFrame(() => {
                            doc.documentElement.scrollLeft = scrollPosition.x;
                            doc.documentElement.scrollTop = scrollPosition.y;
                            doc.body.scrollLeft = scrollPosition.x;
                            doc.body.scrollTop = scrollPosition.y;
                            console.log('Restored scroll position:', scrollPosition);
                        });

                        resolve();
                        return;
                    }
                } catch (error) {
                    console.warn('DOM manipulation failed, using srcDoc fallback:', error);
                }

                // Fallback to srcDoc method
                iframe.srcdoc = newHtml;
                iframe.onload = () => {
                    requestAnimationFrame(() => {
                        const doc = iframe.contentDocument || iframe.contentWindow.document;
                        if (doc) {
                            doc.documentElement.scrollLeft = scrollPosition.x;
                            doc.documentElement.scrollTop = scrollPosition.y;
                            doc.body.scrollLeft = scrollPosition.x;
                            doc.body.scrollTop = scrollPosition.y;
                            console.log('Restored scroll position via srcDoc:', scrollPosition);
                        }
                    });
                    resolve();
                };
            });
        }

        function generateHtml() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;

            let sectionsHtml = '';
            for (let i = 1; i <= sectionCount; i++) {
                sectionsHtml += `
                <div class="section">
                    <h3>Section ${i}</h3>
                    <p>${content} (Section ${i})</p>
                    <p>This is additional content for section ${i} to make the page long enough to scroll. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
                    <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.</p>
                </div>`;
            }

            return `
            <html>
            <head>
                <meta charset="UTF-8">
                <title>${title}</title>
                <style>
                    body { margin: 0; padding: 20px; font-family: Arial, sans-serif; line-height: 1.6; }
                    .section {
                        margin-bottom: 50px;
                        padding: 30px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        background: #f9f9f9;
                    }
                    h1 { color: #333; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
                    h3 { color: #007acc; }
                </style>
            </head>
            <body>
                <div class="test-content">
                    <h1>${title}</h1>
                    <p><strong>Last updated:</strong> ${new Date().toLocaleTimeString()}</p>
                    ${sectionsHtml}
                </div>
            </body>
            </html>`;
        }

        async function updatePreview() {
            const iframe = document.getElementById('preview-iframe');
            const html = generateHtml();

            console.log('Updating preview with scroll preservation...');
            await preserveScrollAndUpdate(iframe, html);
            console.log('Preview update complete!');
        }

        function addSection() {
            sectionCount++;
            updatePreview();
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(updatePreview, 100);

            // Auto-update on input changes (with debounce)
            let updateTimeout;
            function scheduleUpdate() {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(updatePreview, 500);
            }

            document.getElementById('title').addEventListener('input', scheduleUpdate);
            document.getElementById('content').addEventListener('input', scheduleUpdate);
        });
    </script>
</body>
</html>